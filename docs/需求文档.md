# Cyber-Range 靶场平台需求文档（PRD）

## 1. 背景与目标
- **背景**：为网络安全学习/竞赛提供可自助启动的训练靶场与挑战题目，支持在线提交 Flag 并获得积分反馈。
- **目标**：
  - 让用户可以浏览挑战、启动实例、访问靶机、提交 Flag 并得到结果反馈。
  - 形成可运营的训练平台：用户体系、积分体系、排行榜、题库管理与审计能力。
- **非目标（本期不做或后置）**：
  - 完整的比赛编排系统（赛程、报名、赛场分组、题目解锁曲线等）。
  - 复杂团队协作（战队、队内权限、战队积分结算）除非作为后续版本规划。

## 2. 项目现状（与当前代码对齐）
### 2.1 已实现能力
- **前端页面**：登录、仪表盘、挑战列表/启动停止/提交 Flag、排行榜（静态示例）、个人中心（示例）  
  参考：路由 [index.tsx](file:///Users/liujiming/web/cyber-range/web/src/router/index.tsx)
- **后端 API**（Gin）：
  - GET `/api/challenges`：挑战列表
  - POST `/api/challenges/:id/start`：启动挑战实例（Docker 或 Mock）
  - POST `/api/challenges/:id/stop`：停止实例
  - POST `/api/submit`：提交 Flag 校验
  参考：[main.go](file:///Users/liujiming/web/cyber-range/cmd/api/main.go)
- **容器启动逻辑**：通过容器引擎抽象启动镜像并随机映射端口；将 FLAG 注入为环境变量  
  参考：[challenge_service.go](file:///Users/liujiming/web/cyber-range/internal/service/challenge_service.go)

### 2.2 当前缺口
- **用户体系**：注册/登录、鉴权（JWT/Session）、用户信息与权限。
- **积分与排行榜**：提交记录、积分累计、榜单计算与持久化。
- **题库管理**：题目新增/编辑、镜像管理、资源限制、下线/启用。
- **多用户实例隔离**：当前实例按 challengeID 维度单实例简化，不区分用户。
- **配置与运维**：生产化配置加载、日志与审计、限流与安全策略。

## 3. 术语表
- **Challenge/挑战**：一条训练题目，包含标题、描述、类别、难度、分值、镜像等。
- **Instance/实例**：某个用户启动的挑战运行环境（容器/沙箱），含访问端口与状态。
- **Flag**：用于验证完成情况的答案字符串。
- **题目镜像**：用于启动实例的容器镜像（建议为自建镜像仓库中的业务镜像）。

## 4. 角色与权限（目标形态）
- **学员/参赛者（User）**：浏览挑战、启动实例、提交 Flag、查看个人记录与排行榜。
- **管理员（Admin）**：管理题库、用户、积分规则、运行资源与审计。
- **运营（Operator，可选）**：查看数据报表、处理异常题目、发布公告。

## 5. 业务流程（目标形态）
### 5.1 挑战流程
1. 用户登录并进入挑战列表
2. 选择挑战，点击“启动实例”
3. 系统创建实例并返回可访问地址（域名/端口）
4. 用户在浏览器中访问实例并完成题目
5. 用户提交 Flag
6. 系统校验 Flag，返回结果；若正确则记录提交并累计积分
7. 用户可停止实例，或实例达到 TTL 自动回收

### 5.2 管理流程（题库）
1. 管理员创建/编辑挑战：元信息、镜像、端口、资源限制、Flag 策略、分值
2. 上下线挑战并发布到用户侧
3. 监控实例资源与异常，必要时强制回收

## 6. 功能需求（按模块）

### 6.1 认证与用户（P0）
- **注册/登录**：
  - 支持用户名/邮箱 + 密码登录
  - 密码强度校验与加密存储（后端）
  - 登录成功下发 JWT（或 Session），前端持久化并自动续期/刷新（如采用 refresh token）
- **退出登录**：清理本地 token/session
- **用户资料**：
  - 基本信息：昵称、头像（可选）、个人简介（可选）
  - 安全设置：修改密码、登录设备（可选）
- **权限**：
  - 普通用户与管理员角色
  - 管理接口需鉴权与权限校验

### 6.2 挑战与题库（P0）
- **挑战列表**：
  - 筛选：类别、难度、状态（已完成/未完成）
  - 展示：标题、简介、分值、难度、类别、启动状态
- **挑战详情（建议新增页面，P0）**：
  - 完整描述、提示（可选）、启动说明、访问方式、注意事项
- **题库管理（Admin，P0/P1）**：
  - 新增/编辑/下线挑战
  - 镜像信息配置：镜像地址、启动命令（可选）、暴露端口、环境变量模板
  - Flag 策略：静态 Flag（MVP）/ 动态 Flag（P1）
  - 资源限制：CPU/内存/磁盘/最大实例数（P1）

### 6.3 实例生命周期（P0）
- **启动实例**：
  - 以“用户 + challenge”为粒度创建实例
  - 返回实例访问地址（建议返回完整 URL，或返回 host/port 由前端拼接）
  - 幂等：同一用户同一挑战已启动则返回当前实例信息
- **停止实例**：
  - 用户可手动停止；管理员可强制停止
  - 自动回收：实例 TTL 到期自动停止（P1）
- **实例状态查询（建议新增接口，P0）**：
  - 查询实例是否运行、访问地址、创建时间、到期时间（若有 TTL）
- **并发限制（P1）**：
  - 单用户同时运行实例上限
  - 单挑战总实例上限

### 6.4 Flag 提交与积分（P0）
- **提交 Flag**：
  - 输入校验（非空、长度限制、去除首尾空格）
  - 返回：正确/错误、提示文案、得分变化（正确时）
- **计分规则（MVP）**：
  - 每题首次正确得满分；重复正确不再加分
  - 记录所有提交（正确/错误）用于审计
- **反作弊（P1）**：
  - 提交频率限制（按用户、IP）
  - 可疑提交检测（同 IP 多账号等，视需求）

### 6.5 排行榜与个人中心（P0）
- **排行榜**：
  - 全站总分榜（默认）
  - 时间维度（可选）：日榜/周榜/总榜（P1）
  - 展示字段：排名、昵称、总分、完成题数、最近提交时间（可选）
- **个人中心**：
  - 总分、完成挑战列表
  - 提交记录（时间、题目、结果、得分变化）
  - 技能雷达图可作为运营展示（P1），数据来自题目类别分布与完成度

### 6.6 运营与观测（P1）
- **日志与审计**：登录、启动/停止实例、提交 Flag、管理员操作
- **告警**：实例启动失败、镜像拉取失败、资源不足、异常高频提交
- **数据报表**：DAU、启动次数、完成率、题目热度、错误率

## 7. 接口需求（建议规范）
### 7.1 API 基本约定
- Base Path：`/api`
- 响应格式建议统一：
  - `code`：业务码
  - `message`：提示信息
  - `data`：业务数据
- 认证方式：`Authorization: Bearer <token>`（目标形态）

### 7.2 MVP 已有接口（现状）
- GET `/api/challenges`
- POST `/api/challenges/:id/start`
- POST `/api/challenges/:id/stop`
- POST `/api/submit`

### 7.3 建议新增接口（目标）
- GET `/api/me`：获取当前用户信息
- GET `/api/challenges/:id`：挑战详情
- GET `/api/instances/:challengeId`：查询当前用户该挑战实例状态
- GET `/api/leaderboard`：排行榜
- GET `/api/submissions`：提交记录（分页、可筛选）
- Admin：
  - CRUD `/api/admin/challenges`
  - 强制停止实例 `/api/admin/instances/:id/stop`

## 8. 页面与信息架构（IA）
- `/login`：登录/注册入口（MVP 可仅登录）
- `/`：仪表盘（概览指标）
- `/challenges`：挑战列表
- `/challenges/:id`：挑战详情（建议新增）
- `/leaderboard`：排行榜
- `/profile`：个人中心
- `/admin/*`：后台管理（后续）

## 9. 非功能性需求
### 9.1 安全
- 容器隔离：默认非特权、只读文件系统（可选）、最小权限
- 镜像治理：只允许拉取白名单仓库/镜像；镜像扫描（后续）
- 网络策略：实例网络隔离与出网策略按题目需求配置（后续）
- 输入与风控：提交接口限流、防止暴力提交
- 不在日志/响应中泄露 Flag 与敏感配置

### 9.2 性能与可用性
- 启动延迟目标：镜像已缓存时启动在可接受范围内（建议 < 10s，按环境调整）
- 稳定性：后端启动/停止容器失败要有重试与可观测日志
- 并发：明确最大并发用户与实例数，并据此设置限额与队列策略（P1）

### 9.3 可运维性
- 配置：区分 dev/staging/prod；支持从环境变量或配置文件加载
- 日志：结构化日志，便于检索
- 健康检查：应用健康与依赖（Docker/K8s）健康检查端点（建议新增）

## 10. 部署与交付（前端侧）
- 前端为 Vite 静态产物 `web/dist`，可通过 Nginx/对象存储+CDN 部署。
- 建议同域反向代理 `/api` 到后端以避免 CORS 与 Cookie/Token 问题。

## 11. 验收标准（MVP P0）
- 用户可在挑战列表看到挑战并启动实例，获得可访问地址
- 用户可停止实例，实例不可再访问（或提示不可用）
- 用户提交正确 Flag 返回正确并加分；提交错误返回错误且不加分
- 排行榜可展示真实积分排序（不再是静态数据）
- 刷新 SPA 页面不出现 404（部署包含回退到 `index.html`）

